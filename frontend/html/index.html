<!doctype html>
<html>

<head>
    <title>Sachbearbeiter</title>

    <meta charset="UTF-8" />

    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.21/css/uikit.min.css"
    />

    <!-- UIkit JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.21/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.21/js/uikit-icons.min.js"></script>

    <!-- Neovis.js -->
    <script src="https://cdn.neo4jlabs.com/neovis.js/v1.0.0/neovis.js"></script>

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <script type="text/javascript" src="javascript/bundle.min.js"></script>
    <link rel="stylesheet" type="text/css" href="styles/index.css" />

    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        section {
            background-color: lightgrey;
        }

        #viz {
            flex-grow: 1;
        }

        .dialogtext {
            display: inline-block;
            width: 250px;
        }

        .dialoginput {
            display: inline-block;
            width: 123px;
        }

        button {
            text-align: center;
            width: 175px;
        }
    </style>
</head>

<body>
    <nav class="uk-navbar-container" uk-navbar>
        <div class="uk-navbar-left">
            <ul class="uk-navbar-nav" id="customerList">
                <li class="">
                    <a href="#">About</a>
                    <div class="uk-navbar-dropdown">
                        <ul class="uk-nav uk-navbar-dropdown-nav">
                            <li uk-toggle="target: #algorithm">
                                <a href="#">Algorithmen</a>
                            </li>
                            <li uk-toggle="target: #product">
                                <a href="#">Produkt</a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li>
                    <a href="/stammdaten">Stammdaten</a>
                    <div class="uk-navbar-dropdown">
                        <ul class="uk-nav uk-navbar-dropdown-nav">
                            <li uk-toggle="target: #identity" class="">
                                <a href="#">Identity Fraud</a>
                            </li>
                        </ul>
                    </div>
                </li>
                <li>
                    <a href="">Transaktionen</a>
                    <div class="uk-navbar-dropdown">
                        <ul class="uk-nav uk-navbar-dropdown-nav">
                            <li uk-toggle="target: #suspicious" class="">
                                <a href="#">Suspicious Customer</a>
                            </li>
                            <li uk-toggle="target: #customer">
                                <a href="#">Query Customer</a>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>

        </div>
        <div class="uk-navbar-right">
            <p id="result"></p>
        </div>
    </nav>


    <!--customer dialog-->
    <div id="customer" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Abfrage für einen bestimmten Kunden</h2>
            <div class="dialogtext">Name:</div>
            <div class="dialoginput">
                <input id="name" type="text" />
                <br>
            </div>
            <div class="dialogtext">Transaction&nbsp;Limit:</div>
            <div class="dialoginput">
                <input id="limit2" type="number" value="50" />
                <br>
            </div>
            <br>
            <br>
            <div class="dialogtext"></div>
            <div class="dialoginput">Von:&nbsp;
                <input class="uk-checkbox" type="checkbox" id="from" />
            </div>
            <div class="dialoginput">Zu:&nbsp;
                <input class="uk-checkbox" type="checkbox" id="to" />
            </div>
            <br>
            <br>
            <button class="uk-button uk-button-primary uk-modal-close" type="button" id="queryCustomer">Go!</button>
        </div>
    </div>

    <!--suspicious customer dialog-->
    <div id="suspicious" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Abfrage für die verdächtigsten Kunden</h2>
            <div class="dialogtext">Wieviele:</div>
            <div class="dialoginput">
                <input id="limit1" type="number" value="10" />
                <br>
            </div>
            <br>
            <br>
            <button class="uk-button uk-button-primary uk-modal-close" type="button" id="queryBetweenness">Betweenness</button>
            <button class="uk-button uk-button-primary uk-modal-close" type="button" id="queryCloseness">Closeness</button>
        </div>
    </div>

    <!--identity fraud dialog-->
    <div id="identity" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Abfrage für Kunden mit gleichen Daten</h2>
            <div class="dialogtext">Welche Daten?</div>
            <br>
            <div class="dialogtext">Name:&nbsp;</div>
            <input name="data" class="uk-radio" type="radio" id="idName" />
            <br>
            <div class="dialogtext">Adresse:&nbsp;</div>
            <input name="data" class="uk-radio" type="radio" id="idAddress" />
            <br>
            <div class="dialogtext">Telefonnummer:&nbsp;</div>
            <input name="data" class="uk-radio" type="radio" id="idPhone" />
            <br>
            <div class="dialogtext">SSN:&nbsp;</div>
            <input name="data" class="uk-radio" type="radio" id="idSSN" />
            <br>
            <div class="dialogtext">Kreditkarte:&nbsp;</div>
            <input name="data" class="uk-radio" type="radio" id="idCreditCard" />
            <br>
            <br>
            <br>
            <button class="uk-button uk-button-primary uk-modal-close" type="button" id="queryIdentity">Go!</button>
        </div>
    </div>

    <!--product info dialog-->
    <div id="product" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Über das Produkt</h2>
            <ul style="list-style-type: none">
                <li>
                    <b>Fraud Detection GUI Prototyp</b>
                </li>
                <li>
                    <b>Version 0.6</b>
                </li>
                <li>&nbsp;</li>
                <li>
                    <i>Entwickler: Andreas Horvath, Fabian Fromwald, Christoph Schnabl,
                        Peter Kain</i>
                </li>
            </ul>
            <button class="uk-button uk-modal-close" type="button">Close</button>
        </div>
    </div>

    <!--algorithm info dialog-->
    <div id="algorithm" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Über die Algorithmen</h2>
            <ul style="list-style-type: none">
                <li uk-toggle="target: #betweennessInfo"><a>Betweenness Algorithmus</a></li>
                <li uk-toggle="target: #closenessInfo"><a>Closeness Algorithmus</a></li>
            </ul>
            <button class="uk-button uk-modal-close" type="button">Close</button>
        </div>
    </div>

    <div id="betweennessInfo" stack="true" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Betweenness Algorithmus</h2>
            <p>
                Der Betweenness Algorithmus ist gut darin, Kunden zu erkennen, wo wiele Transaktionen
                von oder zu dem Kunden führen. Das kann dazu verwendet werden, um
                Kunden zu erkennen, die nur dazu da sind, Geld an die Betrüger weiterzuleiten.
                Je "aktiver" der Kunde bei Transaktionen ist, desto verdächtiger
                ist er.
            </p>
            <p>
                Der verwendete Algorithmus existiert in Neo4j-Apoc und die Dokumentation dazu findet
                man
                <a target="external" href="https://neo4j-contrib.github.io/neo4j-apoc-procedures/#centrality">hier:</a>
            </p>
            <button class="uk-button uk-modal-close" type="button">Close</button>
        </div>
    </div>

    <div id="closenessInfo" stack="true" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Closeness Algorithmus</h2>
            <p>
                Der Closeness Algorithmus ist misst die durchschnittliche Nähe 
                aller Kunden. Die Kunden mit dem hösten Wert, haben ein erhötes
                Betrugsriko. Diese könnten nur dazu da sein, das Geld der Betrüger 
                weiterzuleiten. Je "zentraller" der Kunde bei Transaktionen ist,
                 desto verdächtiger ist er.
            </p>
            <p>
                Der verwendete Algorithmus existiert in Neo4j-Apoc und die
                Dokumentation dazu findet man 
                <a target="external" href="https://neo4j-contrib.github.io/neo4j-apoc-procedures/#centrality">hier.</a>
            </p>
            <button class="uk-button uk-modal-close" type="button">Close</button>
        </div>
    </div>

    <div id="viz"></div>
    <div style="height: 10px"></div>

    <button id="stabilize" class="uk-button uk-button-primary" style="position: absolute; bottom: 10px; right: 10px;">Stabilize</button>
    <script type="text/javascript">

    /*
        var Router = {
        routes: [],
        mode: null,
        root: '/',
        config: function(options) {
            this.mode = options && options.mode && options.mode == 'history'
                        && !!(history.pushState) ? 'history' : 'hash';
            this.root = options && options.root ? '/' + this.clearSlashes(options.root) + '/' : '/';
            return this;
        },
        getFragment: function() {
            var fragment = '';
            if(this.mode === 'history') {
                fragment = this.clearSlashes(decodeURI(location.pathname + location.search));
                fragment = fragment.replace(/\?(.*)$/, '');
                fragment = this.root != '/' ? fragment.replace(this.root, '') : fragment;
            } else {
                var match = window.location.href.match(/#(.*)$/);
                fragment = match ? match[1] : '';
            }
            return this.clearSlashes(fragment);
        },
        clearSlashes: function(path) {
            return path.toString().replace(/\/$/, '').replace(/^\//, '');
        },
        add: function(re, handler) {
            if(typeof re == 'function') {
                handler = re;
                re = '';
            }
            this.routes.push({ re: re, handler: handler});
            return this;
        },
        remove: function(param) {
            for(var i=0, r; i<this.routes.length, r = this.routes[i]; i++) {
                if(r.handler === param || r.re.toString() === param.toString()) {
                    this.routes.splice(i, 1);
                    return this;
                }
            }
            return this;
        },
        flush: function() {
            this.routes = [];
            this.mode = null;
            this.root = '/';
            return this;
        },
        check: function(f) {
            var fragment = f || this.getFragment();
            for(var i=0; i<this.routes.length; i++) {
                var match = fragment.match(this.routes[i].re);
                if(match) {
                    match.shift();
                    this.routes[i].handler.apply({}, match);
                    return this;
                }
            }
            return this;
        },
        listen: function() {
            var self = this;
            var current = self.getFragment();
            var fn = function() {
                if(current !== self.getFragment()) {
                    current = self.getFragment();
                    self.check(current);
                }
            }
            clearInterval(this.interval);
            this.interval = setInterval(fn, 50);
            return this;
        },
        navigate: function(path) {
            path = path ? path : '';
            if(this.mode === 'history') {
                history.pushState(null, null, this.root + this.clearSlashes(path));
            } else {
                window.location.href = window.location.href.replace(/#(.*)$/, '') + '#' + path;
            }
            return this;
        }
    }

    // configuration
    Router.config({ mode: 'history'});

    // returning the user to the initial state
    Router.navigate();

    Router.add(function() {
        console.log("Hallo Welt");
    });

    Router.add(/about/, function() {
        console.log('about');
    })

    // adding routes
    /*Router
    .add(/about/, function() {
        console.log('about');
    })
    .add(/products\/(.*)\/edit\/(.*)/, function() {
        console.log('products', arguments);
    })
    .add(function() {
        console.log('default');
    })
    .check('/products/12/edit/22').listen();

    // forwarding
    Router.navigate('/about');*/


    var root = null;
    var useHash = true; // Defaults to: false
    var hash = '#!'; // Defaults to: '#'
    //var router = new Navigo(root, useHash, hash);
        /*var root = null;
        var useHash = true; // Defaults to: false
        var hash = '#!'; // Defaults to: '#'
        var router = new Navigo(root, useHash, hash);

        router.on('/hansi', function () {
            console.log("hansi");
        }).resolve();*/
        //server_url: "bolt://35.205.193.55:7687"
        //server_password: "hcvC2ov9ExBt"
        const neo4jURI = "bolt://127.0.0.1:7687";
        const neo4jUSER = "neo4j";
        const neo4jPASS = "root";

        const resultText = $("#result");

        var viz;

        function draw() {
            var config = {
                container_id: "viz",
                server_url: neo4jURI,
                server_user: neo4jUSER,
                server_password: neo4jPASS,
                labels: {
                    "Customer": {
                        "caption": "name",
                        "size": "pagerank",
                        "community": "community"
                    }
                },
                relationships: {
                    "TRANSACTION": {
                        "thickness": "weight",
                        "caption": false,
                        "community": "community",
                        "color": "green"
                    },
                    "HAS_ADDRESS": {
                        "thickness": "weight",
                        "caption": false,
                        "community": "community",
                        "color": "green"
                    },
                    "HAS_SSN": {
                        "thickness": "weight",
                        "caption": false,
                        "community": "community",
                        "color": "green"
                    },
                    "USES_CREDITCARD": {
                        "thickness": "weight",
                        "caption": false,
                        "community": "community",
                        "color": "green"
                    },
                    "USES_PHONENUMBER": {
                        "thickness": "weight",
                        "caption": false,
                        "community": "community",
                        "color": "green"
                    }
                },
                initial_cypher: `match(n:Customer) return n limit 100;`,
                arrows: true,
                hierarchical_layout: true,
                hierarchical_sort_method: "directed"
            };

            viz = new NeoVis.default(config);
            viz.registerOnEvent("completed", printQueryFinished);
            viz.render();
        }

        function printQueryFinished(values) {
            if (values.record_count > 0) {
                resultText.css("color", "green");
                resultText.text(`Query completed, ${values.record_count} results!`);
            } else {
                resultText.css("color", "orange");
                resultText.text("Query completed, no results!");
            }

        }

        $("#stabilize").click(() => {
            viz.stabilize();
        });

        $("#queryBetweenness").click(() => {
            resultText.text("Executing Query... ");
            let limit = parseInt($("#limit1").val());
            var append = ";";
            if (limit !== undefined && !isNaN(limit)) {
                append = `limit ${limit};`;
            }
            let cypher = `match(c:Customer)
                          with collect(c) as customers
                          call apoc.algo.betweenness(['TRANSACTION'], customers, 'BOTH')
                          yield node, score
                          return node, score
                          order by score desc `;

            viz.renderWithCypher(cypher + append);
        });

        $("#queryCloseness").click(() => {
            resultText.text("Executing Query... ");
            let limit = parseInt($("#limit1").val());
            var append = ";";
            if (limit !== undefined && !isNaN(limit)) {
                append = `limit ${limit};`;
            }
            let cypher = `match(c:Customer)
                          with collect(c) as customers
                          call apoc.algo.closeness(['TRANSACTION'], customers, 'BOTH')
                          yield node, score
                          return node, score
                          order by score desc `;
            viz.renderWithCypher(cypher + append);
        });

        $("#queryCustomer").click(() => {
            resultText.text("Executing Query... ");
            let limit = parseInt($("#limit2").val());
            let from = $("#from").is(":checked") ? '>' : '';
            let to = $("#to").is(":checked") ? '<' : '';
            var append = ";";
            if (limit !== undefined && !isNaN(limit)) {
                append = `limit ${limit};`;
            }
            let cypher = `match (c:Customer {name:"${$("#name").val()}"})
                                ${to}-[r:TRANSACTION]-${from}
                                (c2:Customer)
                          return c, r, c2 `;

            viz.renderWithCypher(cypher + append);
        });

        $("#queryIdentity").click(() => {
            resultText.text("Executing Query... ");
            let checked = [$("#idAddress")[0].checked,
            $("#idPhone")[0].checked, $("#idSSN")[0].checked, $("#idCreditCard")[0].checked];

            let cypher = "";
            if($("#idName")[0].checked) {
                cypher = `match(n:Customer)-[r]-(n2:Customer {name: n.name})
                          return n, r, n2;`;
            } else {
                let relation = "";
                if($("#idAddress")[0].checked) {
                    relation = ":HAS_ADDRESS";
                } else if($("#idPhone")[0].checked) {
                    relation = ":USES_PHONENUMBER";
                } else if($("#idSSN")[0].checked) {
                    relation = ":HAS_SSN";
                } else if($("#idCreditCard")[0].checked) {
                    relation = ":USES_CREDITCARD";
                }

                cypher = `match(n:Customer)-[r${relation}]-(n2)-[r2]-(n3:Customer)
                            where labels(n2) <> labels(n)
                            return n, r, n2, r2, n3`;
            }

            viz.renderWithCypher(cypher);
        });
    </script>
</body>

</html>